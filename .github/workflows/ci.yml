name: ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write    # PR ëŒ“ê¸€ ê¶Œí•œ
  checks: write          # ì²´í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ê¶Œí•œ

jobs:
  # ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë¹ ë¥¸ í”¼ë“œë°±)
  quality-check:
    name: ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Node.js 22 ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ðŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
        run: |
          echo "ðŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬..."
          npm audit --audit-level=high
        continue-on-error: true  # ê²½ê³ ëŠ” í—ˆìš©

      - name: ðŸŽ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
        run: npm run format:check

      - name: ðŸ” ë¦°íŠ¸ ê²€ì‚¬
        run: npm run lint

      - name: ðŸ·ï¸ íƒ€ìž… ê²€ì‚¬
        run: npm run typecheck

      - name: ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: npm run build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

  # âœ… CIëŠ” ì½”ë“œ í’ˆì§ˆì—ë§Œ ì§‘ì¤‘ (Docker ë¹Œë“œëŠ” CDì—ì„œ ì²˜ë¦¬)

  # ðŸ“Š ê²°ê³¼ ì¢…í•© ë° PR ì½”ë©˜íŠ¸  
  ci-summary:
    name: ðŸ“Š CI ê²°ê³¼ ì¢…í•©
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always()
    
    steps:
      - name: âœ… PR ìƒíƒœ ì½”ë©˜íŠ¸ (PRì¼ ê²½ìš°ì—ë§Œ)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ðŸ” CI ê²€ì‚¬ ê²°ê³¼')
            );
            
            const qualityResult = '${{ needs.quality-check.result }}';
            const overallSuccess = qualityResult === 'success';
            
            const statusIcon = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¸ï¸';
                default: return 'â³';
              }
            };
            
            const body = `## ðŸ” CI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼
            
            ${overallSuccess ? 'ðŸŽ‰ ëª¨ë“  ê²€ì‚¬ í†µê³¼!' : 'âš ï¸ ê²€ì‚¬ ì‹¤íŒ¨'}
            
            ### ðŸ“Š ê²€ì‚¬ ê²°ê³¼:
            ${statusIcon(qualityResult)} **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬** (${qualityResult})
            - ðŸŽ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ (Prettier)
            - ðŸ” ë¦°íŠ¸ ê²€ì‚¬ (ESLint) 
            - ðŸ·ï¸ íƒ€ìž… ê²€ì‚¬ (TypeScript)
            - ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ (Next.js)
            - ðŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
            
            ${overallSuccess ? 
              'âœ¨ **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼! ì•ˆì „í•˜ê²Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.**' : 
              'ðŸ”§ **ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”.**'}
              
            ðŸ’¡ **ì°¸ê³ :** Docker ë¹Œë“œëŠ” main ë¸Œëžœì¹˜ ë°°í¬ ì‹œ ìžë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
            `;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: ðŸ“Š CI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ìš”ì•½
        if: always()
        run: |
          quality_result="${{ needs.quality-check.result }}"
          
          echo "## ðŸ” CI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ê²€ì‚¬ ê²°ê³¼:" >> $GITHUB_STEP_SUMMARY
          
          if [ "$quality_result" = "success" ]; then
            echo "- âœ… **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬** í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬** ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ ê²€ì‚¬ í•­ëª©:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ (Prettier)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ë¦°íŠ¸ ê²€ì‚¬ (ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ íƒ€ìž… ê²€ì‚¬ (TypeScript)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ (Next.js)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
          
          if [ "$quality_result" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼! ì•ˆì „í•˜ê²Œ ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **ì°¸ê³ :** Docker ë¹Œë“œëŠ” main ë¸Œëžœì¹˜ ë°°í¬ ì‹œ ìžë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
