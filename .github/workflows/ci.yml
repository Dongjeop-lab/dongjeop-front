name: ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write    # PR ëŒ“ê¸€ ê¶Œí•œ
  checks: write          # ì²´í¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ê¶Œí•œ

jobs:
  # ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë¹ ë¥¸ í”¼ë“œë°±)
  quality-check:
    name: ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Node.js 22 ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ðŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
        run: |
          echo "ðŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬..."
          npm audit --audit-level=high
        continue-on-error: true  # ê²½ê³ ëŠ” í—ˆìš©

      - name: ðŸŽ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
        run: npm run format:check

      - name: ðŸ” ë¦°íŠ¸ ê²€ì‚¬
        run: npm run lint

      - name: ðŸ·ï¸ íƒ€ìž… ê²€ì‚¬
        run: npm run typecheck

      - name: ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: npm run build
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          NEXT_PUBLIC_API_URL: http://61.109.238.45:8082

  # ðŸ³ Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ë³‘ë ¬ ì‹¤í–‰)
  docker-test:
    name: ðŸ³ Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ³ Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: |
          echo "ðŸ—ï¸ Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œìž‘..."
          docker build \
            --build-arg NEXT_PUBLIC_API_URL="http://61.109.238.45:8082" \
            -t dongjeop-frontend:ci-test .
          echo "âœ… Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

      - name: ðŸ§ª Docker ì»¨í…Œì´ë„ˆ í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
        run: |
          echo "ðŸ§ª ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸..."
          docker run --rm -d --name test-container \
            -p 3000:3000 dongjeop-frontend:ci-test
          sleep 5
          # ê°„ë‹¨í•œ í—¬ìŠ¤ì²´í¬
          curl -f http://localhost:3000 || exit 1
          docker stop test-container
          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

  # ðŸ“Š ê²°ê³¼ ì¢…í•© ë° PR ì½”ë©˜íŠ¸
  ci-summary:
    name: ðŸ“Š CI ê²°ê³¼ ì¢…í•©
    runs-on: ubuntu-latest
    needs: [quality-check, docker-test]
    if: always()
    
    steps:
      - name: âœ… PR ìƒíƒœ ì½”ë©˜íŠ¸ (PRì¼ ê²½ìš°ì—ë§Œ)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ðŸ” CI ê²€ì‚¬ ê²°ê³¼')
            );
            
            const qualityResult = '${{ needs.quality-check.result }}';
            const dockerResult = '${{ needs.docker-test.result }}';
            const overallSuccess = qualityResult === 'success' && dockerResult === 'success';
            
            const statusIcon = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¸ï¸';
                default: return 'â³';
              }
            };
            
            const body = `## ðŸ” CI ê²€ì‚¬ ê²°ê³¼ (í–¥ìƒëœ ë²„ì „)
            
            ${overallSuccess ? 'ðŸŽ‰ ëª¨ë“  ê²€ì‚¬ í†µê³¼!' : 'âš ï¸ ê²€ì‚¬ ì‹¤íŒ¨ ë˜ëŠ” ì§„í–‰ ì¤‘'}
            
            ### ðŸ“Š ìƒì„¸ ê²°ê³¼:
            ${statusIcon(qualityResult)} **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬** (${qualityResult})
            - ì½”ë“œ ìŠ¤íƒ€ì¼ (Prettier)
            - ë¦°íŠ¸ ê²€ì‚¬ (ESLint) 
            - íƒ€ìž… ê²€ì‚¬ (TypeScript)
            - ë¹Œë“œ í…ŒìŠ¤íŠ¸ (Next.js)
            - ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
            
            ${statusIcon(dockerResult)} **Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸** (${dockerResult})
            - Docker ì´ë¯¸ì§€ ë¹Œë“œ
            - ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
            
            ${overallSuccess ? 
              'âœ¨ **ì´ PRì€ ì•ˆì „í•˜ê²Œ ë³‘í•©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤!**' : 
              'ðŸ”§ **ë¬¸ì œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”.**'}
            `;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: ðŸ“Š CI ìµœì¢… ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          quality_result="${{ needs.quality-check.result }}"
          docker_result="${{ needs.docker-test.result }}"
          
          echo "## ðŸ” CI ê²€ì‚¬ ì™„ë£Œ (í–¥ìƒëœ ë²„ì „)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ê²€ì‚¬ ê²°ê³¼:" >> $GITHUB_STEP_SUMMARY
          
          if [ "$quality_result" = "success" ]; then
            echo "- âœ… **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬** í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬** ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$docker_result" = "success" ]; then
            echo "- âœ… **Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸** í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸** ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ ê²€ì‚¬ í•­ëª©:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ (Prettier)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ë¦°íŠ¸ ê²€ì‚¬ (ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ íƒ€ìž… ê²€ì‚¬ (TypeScript)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ (Next.js)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Docker ë¹Œë“œ ë° ì‹¤í–‰ í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
          
          if [ "$quality_result" = "success" ] && [ "$docker_result" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **ëª¨ë“  ê²€ì‚¬ í†µê³¼! ì•ˆì „í•˜ê²Œ ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.**" >> $GITHUB_STEP_SUMMARY
          fi
