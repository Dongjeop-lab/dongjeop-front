# .github/workflows/deploy.yml

name: ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬

on:
  # ðŸ§ª ìž„ì‹œ: feat/ci-cd-test ë¸Œëžœì¹˜ì—ì„œë„ í…ŒìŠ¤íŠ¸ (ë‚˜ì¤‘ì— ì œê±°)
  push:
    branches: [ main, feat/ci-cd-test ]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: dongjeop-frontend
  
jobs:
  build-and-deploy:
    name: ðŸ³ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ” Docker Registry CA ì¸ì¦ì„œ ì„¤ì •
        run: |
          echo "ðŸ”’ CA ì¸ì¦ì„œ ì„¤ì • ì¤‘..."
          
          # CA ì¸ì¦ì„œ íŒŒì¼ ìƒì„±
          echo "${{ secrets.DOCKER_CA_CERT }}" > /tmp/ca.crt
          
          # Docker certs.d ë””ë ‰í† ë¦¬ ì„¤ì •
          sudo mkdir -p /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}
          sudo cp /tmp/ca.crt /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}/ca.crt
          sudo chmod 644 /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}/ca.crt
          
          # ì‹œìŠ¤í…œ CA ì¸ì¦ì„œ ìŠ¤í† ì–´ì—ë„ ì¶”ê°€
          sudo cp /tmp/ca.crt /usr/local/share/ca-certificates/docker-registry.crt
          sudo update-ca-certificates
          
          # Docker ë°ëª¬ ìž¬ì‹œìž‘ (buildx ì»¨í…Œì´ë„ˆ ìž¬ìƒì„±)
          sudo systemctl restart docker || true
          sleep 3
          
          # ì„¤ì • í™•ì¸
          echo "ðŸ“‹ CA ì¸ì¦ì„œ ì„¤ì • í™•ì¸:"
          ls -la /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}/
          echo "âœ… CA ì¸ì¦ì„œ ì„¤ì • ì™„ë£Œ"

      - name: ðŸ³ Docker Buildx ì„¤ì • (CA ì¸ì¦ì„œ ì„¤ì • í›„)
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.KAKAO_REGISTRY_URL }}
          username: ${{ secrets.KAKAO_REGISTRY_USERNAME }}
          password: ${{ secrets.KAKAO_REGISTRY_PASSWORD }}

      - name: ðŸ·ï¸ Docker ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ìƒì„±
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.KAKAO_REGISTRY_URL }}/${{ secrets.KAKAO_REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short

      - name: ðŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            type=registry,ref=${{ secrets.KAKAO_REGISTRY_URL }}/${{ secrets.KAKAO_REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:cache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ secrets.KAKAO_REGISTRY_URL }}/${{ secrets.KAKAO_REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:cache,mode=max
          build-args: |
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          # ðŸš€ ê³ ì„±ëŠ¥ ë¹Œë“œ ìµœì í™” ì˜µì…˜
          provenance: false
          sbom: false

      - name: ðŸ–¥ï¸ ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ ì„œë²„ ë¬´ì¤‘ë‹¨ ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.KAKAO_SERVER_HOST }}
          username: ${{ secrets.KAKAO_SERVER_USER }}
          key: ${{ secrets.KAKAO_SSH_PRIVATE_KEY }}
          port: ${{ secrets.KAKAO_SERVER_PORT }} # Secretìœ¼ë¡œ í¬íŠ¸ ê´€ë¦¬
          timeout: 45s
          script: |
            set -e
            echo "ðŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œìž‘..."
            
            # --- ë³€ìˆ˜ ì„¤ì • ---
            REGISTRY_URL="${{ secrets.KAKAO_REGISTRY_URL }}"
            REGISTRY_PROJECT="${{ secrets.KAKAO_REGISTRY_PROJECT }}"
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            
            # ì»¨í…Œì´ë„ˆ ì´ë¦„ ì„¤ì • (ê¸°ì¡´, ì‹ ê·œ, ë°±ì—…)
            CONTAINER_NAME="dongjeop-frontend"
            NEW_CONTAINER_NAME="dongjeop-frontend-new"
            OLD_CONTAINER_NAME="dongjeop-frontend-old"
            
            # --- ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ---
            echo "ðŸ”‘ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸..."
            echo "${{ secrets.KAKAO_REGISTRY_PASSWORD }}" | docker login $REGISTRY_URL --username ${{ secrets.KAKAO_REGISTRY_USERNAME }} --password-stdin
            
            echo "ðŸ“¥ ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ..."
            docker pull ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest

            # --- ì´ì „ ë°°í¬ ì‹¤íŒ¨ ì‹œ ë‚¨ì€ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ---
            docker stop ${NEW_CONTAINER_NAME} >/dev/null 2>&1 && docker rm ${NEW_CONTAINER_NAME} >/dev/null 2>&1 || true
            
            # --- ìƒˆ ë²„ì „ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ---
            echo "ðŸŽ¯ ìƒˆ ë²„ì „ ì»¨í…Œì´ë„ˆ ì‹œìž‘: ${NEW_CONTAINER_NAME}"
            docker run -d \
              --name ${NEW_CONTAINER_NAME} \
              --restart unless-stopped \
              -p 3001:3000 \
              -e NODE_ENV=production \
              -e NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
              ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest

            # --- ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ---
            echo "ðŸ¥ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬..."
            sleep 10
            for i in {1..12}; do
                if curl -f http://localhost:3001 >/dev/null 2>&1; then
                    echo "âœ… ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                    
                    # --- ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë°±ì—…ìœ¼ë¡œ ë³€ê²½í•˜ê³  ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ í˜„ìž¬ ë²„ì „ìœ¼ë¡œ ì ìš© ---
                    if docker ps -q -f name=${CONTAINER_NAME} | grep -q .; then
                      echo "ðŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë°±ì—…ìœ¼ë¡œ ë³€ê²½: ${OLD_CONTAINER_NAME}"
                      docker rename ${CONTAINER_NAME} ${OLD_CONTAINER_NAME}
                    fi
                    
                    echo "ðŸš€ ìƒˆ ë²„ì „ì„ í˜„ìž¬ ë²„ì „ìœ¼ë¡œ ì ìš©: ${CONTAINER_NAME}"
                    docker rename ${NEW_CONTAINER_NAME} ${CONTAINER_NAME}
                    
                    # --- ë°±ì—… ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ ---
                    if docker ps -a -q -f name=${OLD_CONTAINER_NAME} | grep -q .; then
                      echo "ðŸ›‘ ë°±ì—… ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
                      docker stop ${OLD_CONTAINER_NAME}
                      docker rm ${OLD_CONTAINER_NAME}
                    fi
                    
                    break
                fi
                if [ $i -eq 12 ]; then
                    echo "âŒ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ ë¡¤ë°±"
                    docker logs ${NEW_CONTAINER_NAME}
                    docker stop ${NEW_CONTAINER_NAME}
                    docker rm ${NEW_CONTAINER_NAME}
                    exit 1
                fi
                echo "ìž¬ì‹œë„ ($i/12)..."
                sleep 5
            done

            # --- ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ ---
            echo "ðŸ§¹ ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -f
            
            echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ!"

      - name: ðŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… í’ˆì§ˆ ê²€ì‚¬ ë° ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì„œë²„ ë°°í¬ ë° í—¬ìŠ¤ ì²´í¬ ì™„ë£Œ (ë¬´ì¤‘ë‹¨)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì´ë¯¸ì§€:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "**ë°°í¬ ì‹œê°„:** $(date)" >> $GITHUB_STEP_SUMMARY