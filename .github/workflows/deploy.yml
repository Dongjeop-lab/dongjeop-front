# .github/workflows/deploy.yml

name: ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬

on:
  push:
    branches: [ main, develop, chore/ci-cd-button ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'ê°•ì œ ë¦¬ë¹Œë“œ (ìºì‹œ ë¬´ì‹œ)'
        required: false
        type: boolean
        default: false
      deploy_message:
        description: 'ë°°í¬ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)'
        required: false
        type: string
        default: 'ìžë™ ë°°í¬'

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: dongjeop-frontend
  
jobs:
  build-and-deploy:
    name: ðŸ³ ë¹Œë“œ ë° ë°°í¬ (${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ” Docker Registry CA ì¸ì¦ì„œ ì„¤ì •
        run: |
          echo "ðŸ”’ CA ì¸ì¦ì„œ ì„¤ì • ì¤‘..."
          
          # CA ì¸ì¦ì„œ íŒŒì¼ ìƒì„±
          echo "${{ secrets.DOCKER_CA_CERT }}" > /tmp/ca.crt
          
          # CA ì¸ì¦ì„œ ìœ íš¨ì„± ê²€ì‚¬
          if [ -s /tmp/ca.crt ] && openssl x509 -in /tmp/ca.crt -text -noout > /dev/null 2>&1; then
            echo "âœ… CA ì¸ì¦ì„œ ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ CA ì¸ì¦ì„œ ì˜¤ë¥˜"
            exit 1
          fi
          
          # Docker certs.d ë””ë ‰í† ë¦¬ ì„¤ì •
          sudo mkdir -p /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}
          sudo cp /tmp/ca.crt /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}/ca.crt
          sudo chmod 644 /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}/ca.crt
          
          # ì‹œìŠ¤í…œ CA ì¸ì¦ì„œ ìŠ¤í† ì–´ì—ë„ ì¶”ê°€
          sudo cp /tmp/ca.crt /usr/local/share/ca-certificates/docker-registry.crt
          sudo update-ca-certificates
          
          # Buildxê°€ ì¸ì‹í•  ìˆ˜ ìžˆë„ë¡ ì¶”ê°€ ìœ„ì¹˜ì—ë„ ë³µì‚¬
          sudo mkdir -p /etc/ssl/certs
          sudo cp /tmp/ca.crt /etc/ssl/certs/docker-registry.pem
          sudo chmod 644 /etc/ssl/certs/docker-registry.pem
          
          # Docker ë°ëª¬ ìž¬ì‹œìž‘
          sudo systemctl restart docker || true
          sleep 3

      - name: ðŸ³ Docker Buildx ì„¤ì • (CA ì¸ì¦ì„œ ì„¤ì • í›„)
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config-inline: |
            [registry."${{ secrets.KAKAO_REGISTRY_URL }}"]
              ca = ["/etc/ssl/certs/docker-registry.pem"]

      - name: ðŸ”‘ ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.KAKAO_REGISTRY_URL }}
          username: ${{ secrets.KAKAO_REGISTRY_USERNAME }}
          password: ${{ secrets.KAKAO_REGISTRY_PASSWORD }}

      - name: ðŸ·ï¸ Docker ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ìƒì„±
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.KAKAO_REGISTRY_URL }}/${{ secrets.KAKAO_REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}
          tags: |
            # ë¸Œëžœì¹˜ë³„ íƒœê·¸
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/develop' }}
            # ìˆ˜ë™ ë°°í¬ ì‹œ íƒ€ìž„ìŠ¤íƒ¬í”„ íƒœê·¸ ì¶”ê°€
            type=raw,value=manual-{{date 'YYYYMMDD-HHmmss'}},enable=${{ github.event_name == 'workflow_dispatch' }}
            # ì»¤ë°‹ SHA íƒœê·¸
            type=sha,format=short

      - name: ðŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ë³´ì•ˆ CA ì¸ì¦ì„œ ì‚¬ìš©)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NODE_ENV=production
            NEXT_PUBLIC_BUILD_ID=${{ github.sha }}
            DEPLOY_MESSAGE=${{ github.event.inputs.deploy_message || 'ìˆ˜ë™ ë°°í¬' }}
            BUILD_ENV=${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
          # ìºì‹œ ì„¤ì • (ê°•ì œ ë¦¬ë¹Œë“œ ì˜µì…˜ ì ìš©)
          cache-from: ${{ github.event.inputs.force_rebuild == 'true' && '' || 'type=gha' }}
          cache-to: type=gha,mode=max
          # ðŸ”’ ë³´ì•ˆ ê°•í™”: CA ì¸ì¦ì„œ ì‚¬ìš©, insecure ëª¨ë“œ ì œê±°
          provenance: false
          sbom: false

      - name: ðŸ–¥ï¸ ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ ì„œë²„ ë¬´ì¤‘ë‹¨ ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.KAKAO_SERVER_HOST }}
          username: ${{ secrets.KAKAO_SERVER_USER }}
          key: ${{ secrets.KAKAO_SSH_PRIVATE_KEY }}
          port: ${{ secrets.KAKAO_SERVER_PORT }} # Secretìœ¼ë¡œ í¬íŠ¸ ê´€ë¦¬
          timeout: 45s
          script: |
            set -e
            echo "ðŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œìž‘..."
            
            # --- ë³€ìˆ˜ ì„¤ì • ---
            REGISTRY_URL="${{ secrets.KAKAO_REGISTRY_URL }}"
            REGISTRY_PROJECT="${{ secrets.KAKAO_REGISTRY_PROJECT }}"
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            
            # ì»¨í…Œì´ë„ˆ ì´ë¦„ ì„¤ì • (ê¸°ì¡´, ì‹ ê·œ, ë°±ì—…)
            CONTAINER_NAME="dongjeop-frontend"
            NEW_CONTAINER_NAME="dongjeop-frontend-new"
            OLD_CONTAINER_NAME="dongjeop-frontend-old"
            
            # --- ë°°í¬ ì „ í™˜ê²½ ì •ë¦¬ ---
            echo "ðŸ§¹ ë°°í¬ ì „ í™˜ê²½ ì •ë¦¬..."
            
            # í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            sudo docker ps --filter "name=dongjeop-frontend" --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}" || true
            
            # ìƒˆ ì»¨í…Œì´ë„ˆì™€ ë°±ì—… ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ê¸°ì¡´ ë©”ì¸ ì„œë¹„ìŠ¤ëŠ” ìœ ì§€)
            sudo docker stop ${NEW_CONTAINER_NAME} >/dev/null 2>&1 && sudo docker rm ${NEW_CONTAINER_NAME} >/dev/null 2>&1 || true
            
            # ê¸°ì¡´ ë°±ì—… ì»¨í…Œì´ë„ˆ ì •ë¦¬
            sudo docker stop ${OLD_CONTAINER_NAME} >/dev/null 2>&1 && sudo docker rm ${OLD_CONTAINER_NAME} >/dev/null 2>&1 || true
            
            # --- ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ---
            echo "ðŸ”‘ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸..."
            echo "${{ secrets.KAKAO_REGISTRY_PASSWORD }}" | sudo docker login $REGISTRY_URL --username ${{ secrets.KAKAO_REGISTRY_USERNAME }} --password-stdin
            
            echo "ðŸ“¥ ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ..."
            sudo docker pull ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest
            
            # --- ìƒˆ ë²„ì „ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ìž„ì‹œ í¬íŠ¸ ì‚¬ìš©) ---
            TEMP_PORT=3002
            echo "ðŸŽ¯ ìƒˆ ë²„ì „ ì»¨í…Œì´ë„ˆ ì‹œìž‘: ${NEW_CONTAINER_NAME} (ìž„ì‹œ í¬íŠ¸: ${TEMP_PORT})"
            sudo docker run -d \
              --name ${NEW_CONTAINER_NAME} \
              --restart unless-stopped \
              -p ${TEMP_PORT}:3000 \
              -e NODE_ENV=production \
              -e NEXT_PUBLIC_BUILD_ID="${{ github.sha }}" \
              -e BUILD_ENV="${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}" \
              ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest

            # --- ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ---
            echo "ðŸ¥ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ (í¬íŠ¸: ${TEMP_PORT})..."
            sleep 10
            for i in {1..12}; do
                if curl -f http://localhost:${TEMP_PORT} >/dev/null 2>&1; then
                    echo "âœ… ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                    
                    # --- ë¬´ì¤‘ë‹¨ í¬íŠ¸ ì „í™˜ ì‹œìž‘ ---
                    echo "ðŸ”„ ë¬´ì¤‘ë‹¨ í¬íŠ¸ ì „í™˜ ì‹œìž‘..."
                    
                    # 1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
                    echo "ðŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
                    sudo docker stop ${CONTAINER_NAME} >/dev/null 2>&1 || true
                    sudo docker rm ${CONTAINER_NAME} >/dev/null 2>&1 || true
                    
                    # 2. ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë©”ì¸ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ì‹œìž‘
                    echo "ðŸš€ ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë©”ì¸ìœ¼ë¡œ ì‹œìž‘: ${CONTAINER_NAME}"
                    sudo docker stop ${NEW_CONTAINER_NAME}
                    sudo docker rm ${NEW_CONTAINER_NAME}
                    
                    # í¬íŠ¸ê°€ ì™„ì „ížˆ í•´ì œë  ë•Œê¹Œì§€ ìž ì‹œ ëŒ€ê¸°
                    sleep 3
                    
                    sudo docker run -d \
                      --name ${CONTAINER_NAME} \
                      --restart unless-stopped \
                      -p 3001:3000 \
                      -e NODE_ENV=production \
                      -e NEXT_PUBLIC_BUILD_ID="${{ github.sha }}" \
                      -e BUILD_ENV="${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}" \
                      ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest
                    
                    # 3. ë©”ì¸ í¬íŠ¸ í—¬ìŠ¤ ì²´í¬
                    echo "ðŸ¥ ë©”ì¸ í¬íŠ¸ í—¬ìŠ¤ ì²´í¬..."
                    sleep 5
                    for j in {1..6}; do
                      if curl -f http://localhost:3001 >/dev/null 2>&1; then
                        echo "âœ… ë©”ì¸ í¬íŠ¸ ì „í™˜ ì„±ê³µ!"
                        break
                      fi
                      if [ $j -eq 6 ]; then
                        echo "âŒ ë©”ì¸ í¬íŠ¸ ì „í™˜ ì‹¤íŒ¨, ë°°í¬ ì‹¤íŒ¨"
                        sudo docker stop ${CONTAINER_NAME} >/dev/null 2>&1 || true
                        sudo docker rm ${CONTAINER_NAME} >/dev/null 2>&1 || true
                        exit 1
                      fi
                      echo "ìž¬ì‹œë„ ($j/6)..."
                      sleep 3
                    done
                    
                    echo "âœ… ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ!"
                    
                    break
                fi
                if [ $i -eq 12 ]; then
                    echo "âŒ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ ë¡¤ë°±"
                    sudo docker logs ${NEW_CONTAINER_NAME}
                    sudo docker stop ${NEW_CONTAINER_NAME}
                    sudo docker rm ${NEW_CONTAINER_NAME}
                    exit 1
                fi
                echo "ìž¬ì‹œë„ ($i/12)..."
                sleep 5
            done

            # --- ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ ---
            echo "ðŸ§¹ ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬..."
            sudo docker image prune -f
            
            echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ!"

      - name: ðŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì„œë²„ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ë°°í¬ ì •ë³´
          echo "**ë°°í¬ í™˜ê²½:** ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**ë°°í¬ ë°©ì‹:** ${{ github.event_name == 'workflow_dispatch' && 'ðŸ”˜ ìˆ˜ë™ ë°°í¬' || 'ðŸ”„ ìžë™ ë°°í¬' }}" >> $GITHUB_STEP_SUMMARY
          
          # ìˆ˜ë™ ë°°í¬ ì‹œ ì¶”ê°€ ì •ë³´
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**ë°°í¬ ë©”ì‹œì§€:** ${{ github.event.inputs.deploy_message }}" >> $GITHUB_STEP_SUMMARY
            echo "**ê°•ì œ ë¦¬ë¹Œë“œ:** ${{ github.event.inputs.force_rebuild == 'true' && 'âœ… í™œì„±í™”' || 'âŒ ë¹„í™œì„±í™”' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**ë°°í¬ ì‹œê°„:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**ì»¤ë°‹ SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì´ë¯¸ì§€ íƒœê·¸ë“¤:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY