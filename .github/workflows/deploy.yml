# .github/workflows/deploy.yml

name: ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬

on:
  # ðŸ§ª ìž„ì‹œ: feat/ci-cd-test ë¸Œëžœì¹˜ì—ì„œë„ í…ŒìŠ¤íŠ¸ (ë‚˜ì¤‘ì— ì œê±°)
  push:
    branches: [ main, feat/ci-cd-test ]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: dongjeop-frontend
  
jobs:
  build-and-deploy:
    name: ðŸ³ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ” Docker Registry CA ì¸ì¦ì„œ ì„¤ì •
        run: |
          echo "ðŸ”’ CA ì¸ì¦ì„œ ì„¤ì • ì¤‘..."
          
          # CA ì¸ì¦ì„œ íŒŒì¼ ìƒì„±
          echo "${{ secrets.DOCKER_CA_CERT }}" > /tmp/ca.crt
          
          # CA ì¸ì¦ì„œ ìœ íš¨ì„± ê²€ì‚¬
          if [ -s /tmp/ca.crt ] && openssl x509 -in /tmp/ca.crt -text -noout > /dev/null 2>&1; then
            echo "âœ… CA ì¸ì¦ì„œ ì„¤ì • ì™„ë£Œ"
          else
            echo "âŒ CA ì¸ì¦ì„œ ì˜¤ë¥˜"
            exit 1
          fi
          
          # Docker certs.d ë””ë ‰í† ë¦¬ ì„¤ì •
          sudo mkdir -p /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}
          sudo cp /tmp/ca.crt /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}/ca.crt
          sudo chmod 644 /etc/docker/certs.d/${{ secrets.KAKAO_REGISTRY_URL }}/ca.crt
          
          # ì‹œìŠ¤í…œ CA ì¸ì¦ì„œ ìŠ¤í† ì–´ì—ë„ ì¶”ê°€
          sudo cp /tmp/ca.crt /usr/local/share/ca-certificates/docker-registry.crt
          sudo update-ca-certificates
          
          # Buildxê°€ ì¸ì‹í•  ìˆ˜ ìžˆë„ë¡ ì¶”ê°€ ìœ„ì¹˜ì—ë„ ë³µì‚¬
          sudo mkdir -p /etc/ssl/certs
          sudo cp /tmp/ca.crt /etc/ssl/certs/docker-registry.pem
          sudo chmod 644 /etc/ssl/certs/docker-registry.pem
          
          # Docker ë°ëª¬ ìž¬ì‹œìž‘
          sudo systemctl restart docker || true
          sleep 3

      - name: ðŸ³ Docker Buildx ì„¤ì • (CA ì¸ì¦ì„œ ì„¤ì • í›„)
        uses: docker/setup-buildx-action@v3
        with:
          config-inline: |
            [registry."${{ secrets.KAKAO_REGISTRY_URL }}"]
              ca = ["/etc/ssl/certs/docker-registry.pem"]

      - name: ðŸ”‘ ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.KAKAO_REGISTRY_URL }}
          username: ${{ secrets.KAKAO_REGISTRY_USERNAME }}
          password: ${{ secrets.KAKAO_REGISTRY_PASSWORD }}

      - name: ðŸ·ï¸ Docker ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ìƒì„±
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.KAKAO_REGISTRY_URL }}/${{ secrets.KAKAO_REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short

      - name: ðŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ë³´ì•ˆ CA ì¸ì¦ì„œ ì‚¬ìš©)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.KAKAO_REGISTRY_URL }}/${{ secrets.KAKAO_REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:latest
            ${{ secrets.KAKAO_REGISTRY_URL }}/${{ secrets.KAKAO_REGISTRY_PROJECT }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          build-args: |
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          # ðŸ”’ ë³´ì•ˆ ê°•í™”: CA ì¸ì¦ì„œ ì‚¬ìš©, insecure ëª¨ë“œ ì œê±°
          provenance: false
          sbom: false

      - name: ðŸ–¥ï¸ ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ ì„œë²„ ë¬´ì¤‘ë‹¨ ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.KAKAO_SERVER_HOST }}
          username: ${{ secrets.KAKAO_SERVER_USER }}
          key: ${{ secrets.KAKAO_SSH_PRIVATE_KEY }}
          port: ${{ secrets.KAKAO_SERVER_PORT }} # Secretìœ¼ë¡œ í¬íŠ¸ ê´€ë¦¬
          timeout: 45s
          script: |
            set -e
            echo "ðŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œìž‘..."
            
            # --- ë³€ìˆ˜ ì„¤ì • ---
            REGISTRY_URL="${{ secrets.KAKAO_REGISTRY_URL }}"
            REGISTRY_PROJECT="${{ secrets.KAKAO_REGISTRY_PROJECT }}"
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            
            # ì»¨í…Œì´ë„ˆ ì´ë¦„ ì„¤ì • (ê¸°ì¡´, ì‹ ê·œ, ë°±ì—…)
            CONTAINER_NAME="dongjeop-frontend"
            NEW_CONTAINER_NAME="dongjeop-frontend-new"
            OLD_CONTAINER_NAME="dongjeop-frontend-old"
            
            # --- ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìœ„í•œ ì´ì „ ë°°í¬ ì‹¤íŒ¨ ì»¨í…Œì´ë„ˆë§Œ ì •ë¦¬ ---
            echo "ðŸ§¹ ì´ì „ ë°°í¬ ì‹¤íŒ¨ ì‹œ ë‚¨ì€ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
            
            # ìƒˆ ì»¨í…Œì´ë„ˆì™€ ë°±ì—… ì»¨í…Œì´ë„ˆë§Œ ì •ë¦¬ (ê¸°ì¡´ ì„œë¹„ìŠ¤ëŠ” ìœ ì§€)
            sudo docker stop ${NEW_CONTAINER_NAME} >/dev/null 2>&1 && sudo docker rm ${NEW_CONTAINER_NAME} >/dev/null 2>&1 || true
            sudo docker stop ${OLD_CONTAINER_NAME} >/dev/null 2>&1 && sudo docker rm ${OLD_CONTAINER_NAME} >/dev/null 2>&1 || true
            
            # --- ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ---
            echo "ðŸ”‘ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸..."
            echo "${{ secrets.KAKAO_REGISTRY_PASSWORD }}" | sudo docker login $REGISTRY_URL --username ${{ secrets.KAKAO_REGISTRY_USERNAME }} --password-stdin
            
            echo "ðŸ“¥ ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ..."
            sudo docker pull ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest
            
            # --- ìƒˆ ë²„ì „ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ìž„ì‹œ í¬íŠ¸ ì‚¬ìš©) ---
            TEMP_PORT=3002
            echo "ðŸŽ¯ ìƒˆ ë²„ì „ ì»¨í…Œì´ë„ˆ ì‹œìž‘: ${NEW_CONTAINER_NAME} (ìž„ì‹œ í¬íŠ¸: ${TEMP_PORT})"
            sudo docker run -d \
              --name ${NEW_CONTAINER_NAME} \
              --restart unless-stopped \
              -p ${TEMP_PORT}:3000 \
              -e NODE_ENV=production \
              -e NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
              ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest

            # --- ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ---
            echo "ðŸ¥ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ (í¬íŠ¸: ${TEMP_PORT})..."
            sleep 10
            for i in {1..12}; do
                if curl -f http://localhost:${TEMP_PORT} >/dev/null 2>&1; then
                    echo "âœ… ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                    
                    # --- ë¬´ì¤‘ë‹¨ í¬íŠ¸ ì „í™˜ ì‹œìž‘ ---
                    echo "ðŸ”„ ë¬´ì¤‘ë‹¨ í¬íŠ¸ ì „í™˜ ì‹œìž‘..."
                    
                    # 1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë°±ì—…ìœ¼ë¡œ ì´ë™ (ì„œë¹„ìŠ¤ëŠ” ê³„ì† ì‹¤í–‰)
                    if sudo docker ps -q -f name=^${CONTAINER_NAME}$ | grep -q .; then
                      echo "ðŸ“¦ ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë°±ì—…ìœ¼ë¡œ ë³€ê²½: ${OLD_CONTAINER_NAME}"
                      # ê¸°ì¡´ ë°±ì—… ì»¨í…Œì´ë„ˆê°€ ìžˆë‹¤ë©´ ë¨¼ì € ì œê±°
                      sudo docker stop ${OLD_CONTAINER_NAME} >/dev/null 2>&1 && sudo docker rm ${OLD_CONTAINER_NAME} >/dev/null 2>&1 || true
                      sudo docker rename ${CONTAINER_NAME} ${OLD_CONTAINER_NAME}
                    fi
                    
                    # 2. ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë©”ì¸ í¬íŠ¸(3001)ë¡œ ìž¬ì‹œìž‘
                    echo "ðŸš€ ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë©”ì¸ í¬íŠ¸ë¡œ ì „í™˜: ${CONTAINER_NAME}"
                    sudo docker stop ${NEW_CONTAINER_NAME}
                    sudo docker rm ${NEW_CONTAINER_NAME}
                    
                    sudo docker run -d \
                      --name ${CONTAINER_NAME} \
                      --restart unless-stopped \
                      -p 3001:3000 \
                      -e NODE_ENV=production \
                      -e NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
                      ${REGISTRY_URL}/${REGISTRY_PROJECT}/${IMAGE_NAME}:latest
                    
                    # 3. ë©”ì¸ í¬íŠ¸ í—¬ìŠ¤ ì²´í¬
                    echo "ðŸ¥ ë©”ì¸ í¬íŠ¸ í—¬ìŠ¤ ì²´í¬..."
                    sleep 5
                    for j in {1..6}; do
                      if curl -f http://localhost:3001 >/dev/null 2>&1; then
                        echo "âœ… ë©”ì¸ í¬íŠ¸ ì „í™˜ ì„±ê³µ!"
                        break
                      fi
                      if [ $j -eq 6 ]; then
                        echo "âŒ ë©”ì¸ í¬íŠ¸ ì „í™˜ ì‹¤íŒ¨, ë¡¤ë°± ì¤‘..."
                        # ë¡¤ë°±: ë°±ì—… ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ë©”ì¸ìœ¼ë¡œ
                        sudo docker stop ${CONTAINER_NAME} >/dev/null 2>&1 && sudo docker rm ${CONTAINER_NAME} >/dev/null 2>&1 || true
                        if sudo docker ps -a -q -f name=^${OLD_CONTAINER_NAME}$ | grep -q .; then
                          sudo docker rename ${OLD_CONTAINER_NAME} ${CONTAINER_NAME}
                        fi
                        exit 1
                      fi
                      echo "ìž¬ì‹œë„ ($j/6)..."
                      sleep 3
                    done
                    
                    # 4. ë°±ì—… ì»¨í…Œì´ë„ˆ ì •ë¦¬ (30ì´ˆ í›„)
                    if sudo docker ps -a -q -f name=^${OLD_CONTAINER_NAME}$ | grep -q .; then
                      echo "ðŸ›‘ ë°±ì—… ì»¨í…Œì´ë„ˆ ì •ë¦¬ (30ì´ˆ ëŒ€ê¸° í›„)"
                      sleep 30
                      sudo docker stop ${OLD_CONTAINER_NAME} >/dev/null 2>&1 || true
                      sudo docker rm ${OLD_CONTAINER_NAME} >/dev/null 2>&1 || true
                    fi
                    
                    break
                fi
                if [ $i -eq 12 ]; then
                    echo "âŒ ìƒˆ ë²„ì „ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ ë¡¤ë°±"
                    sudo docker logs ${NEW_CONTAINER_NAME}
                    sudo docker stop ${NEW_CONTAINER_NAME}
                    sudo docker rm ${NEW_CONTAINER_NAME}
                    exit 1
                fi
                echo "ìž¬ì‹œë„ ($i/12)..."
                sleep 5
            done

            # --- ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ ---
            echo "ðŸ§¹ ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬..."
            sudo docker image prune -f
            
            echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ!"

      - name: ðŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… í’ˆì§ˆ ê²€ì‚¬ ë° ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì„œë²„ ë°°í¬ ë° í—¬ìŠ¤ ì²´í¬ ì™„ë£Œ (ë¬´ì¤‘ë‹¨)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì´ë¯¸ì§€:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "**ë°°í¬ ì‹œê°„:** $(date)" >> $GITHUB_STEP_SUMMARY